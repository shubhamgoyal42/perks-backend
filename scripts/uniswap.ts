import hardhat, { ethers } from "hardhat";
import { Buffer } from 'buffer';
import { BigNumber, Contract, utils } from "ethers";

const poolManagerABI = [{ "inputs": [{ "internalType": "uint256", "name": "controllerGasLimit", "type": "uint256" }], "stateMutability": "nonpayable", "type": "constructor" }, { "inputs": [], "name": "CannotUpdateEmptyPosition", "type": "error" }, { "inputs": [], "name": "CurrenciesInitializedOutOfOrder", "type": "error" }, { "inputs": [], "name": "CurrencyNotSettled", "type": "error" }, { "inputs": [], "name": "DelegateCallNotAllowed", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "sender", "type": "address" }, { "internalType": "uint256", "name": "balance", "type": "uint256" }, { "internalType": "uint256", "name": "needed", "type": "uint256" }, { "internalType": "uint256", "name": "tokenId", "type": "uint256" }], "name": "ERC1155InsufficientBalance", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "approver", "type": "address" }], "name": "ERC1155InvalidApprover", "type": "error" }, { "inputs": [{ "internalType": "uint256", "name": "idsLength", "type": "uint256" }, { "internalType": "uint256", "name": "valuesLength", "type": "uint256" }], "name": "ERC1155InvalidArrayLength", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "operator", "type": "address" }], "name": "ERC1155InvalidOperator", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "receiver", "type": "address" }], "name": "ERC1155InvalidReceiver", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "sender", "type": "address" }], "name": "ERC1155InvalidSender", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "operator", "type": "address" }, { "internalType": "address", "name": "owner", "type": "address" }], "name": "ERC1155MissingApprovalForAll", "type": "error" }, { "inputs": [], "name": "ERC20TransferFailed", "type": "error" }, { "inputs": [], "name": "FeeTooLarge", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "hooks", "type": "address" }], "name": "HookAddressNotValid", "type": "error" }, { "inputs": [], "name": "InvalidCaller", "type": "error" }, { "inputs": [], "name": "InvalidHookResponse", "type": "error" }, { "inputs": [], "name": "InvalidSqrtRatio", "type": "error" }, { "inputs": [], "name": "InvalidTick", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "locker", "type": "address" }], "name": "LockedBy", "type": "error" }, { "inputs": [], "name": "MaxCurrenciesTouched", "type": "error" }, { "inputs": [], "name": "NativeTransferFailed", "type": "error" }, { "inputs": [], "name": "NoLiquidityToReceiveFees", "type": "error" }, { "inputs": [], "name": "NotPoolManagerToken", "type": "error" }, { "inputs": [], "name": "PoolAlreadyInitialized", "type": "error" }, { "inputs": [], "name": "PoolNotInitialized", "type": "error" }, { "inputs": [{ "internalType": "uint160", "name": "sqrtPriceCurrentX96", "type": "uint160" }, { "internalType": "uint160", "name": "sqrtPriceLimitX96", "type": "uint160" }], "name": "PriceLimitAlreadyExceeded", "type": "error" }, { "inputs": [{ "internalType": "uint160", "name": "sqrtPriceLimitX96", "type": "uint160" }], "name": "PriceLimitOutOfBounds", "type": "error" }, { "inputs": [], "name": "ProtocolFeeCannotBeFetched", "type": "error" }, { "inputs": [], "name": "SwapAmountCannotBeZero", "type": "error" }, { "inputs": [{ "internalType": "int24", "name": "tick", "type": "int24" }], "name": "TickLiquidityOverflow", "type": "error" }, { "inputs": [{ "internalType": "int24", "name": "tickLower", "type": "int24" }], "name": "TickLowerOutOfBounds", "type": "error" }, { "inputs": [{ "internalType": "int24", "name": "tick", "type": "int24" }, { "internalType": "int24", "name": "tickSpacing", "type": "int24" }], "name": "TickMisaligned", "type": "error" }, { "inputs": [], "name": "TickSpacingTooLarge", "type": "error" }, { "inputs": [], "name": "TickSpacingTooSmall", "type": "error" }, { "inputs": [{ "internalType": "int24", "name": "tickUpper", "type": "int24" }], "name": "TickUpperOutOfBounds", "type": "error" }, { "inputs": [{ "internalType": "int24", "name": "tickLower", "type": "int24" }, { "internalType": "int24", "name": "tickUpper", "type": "int24" }], "name": "TicksMisordered", "type": "error" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "account", "type": "address" }, { "indexed": true, "internalType": "address", "name": "operator", "type": "address" }, { "indexed": false, "internalType": "bool", "name": "approved", "type": "bool" }], "name": "ApprovalForAll", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "PoolId", "name": "id", "type": "bytes32" }, { "indexed": false, "internalType": "uint24", "name": "hookFees", "type": "uint24" }], "name": "HookFeeUpdated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "PoolId", "name": "id", "type": "bytes32" }, { "indexed": true, "internalType": "Currency", "name": "currency0", "type": "address" }, { "indexed": true, "internalType": "Currency", "name": "currency1", "type": "address" }, { "indexed": false, "internalType": "uint24", "name": "fee", "type": "uint24" }, { "indexed": false, "internalType": "int24", "name": "tickSpacing", "type": "int24" }, { "indexed": false, "internalType": "contract IHooks", "name": "hooks", "type": "address" }], "name": "Initialize", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "PoolId", "name": "id", "type": "bytes32" }, { "indexed": true, "internalType": "address", "name": "sender", "type": "address" }, { "indexed": false, "internalType": "int24", "name": "tickLower", "type": "int24" }, { "indexed": false, "internalType": "int24", "name": "tickUpper", "type": "int24" }, { "indexed": false, "internalType": "int256", "name": "liquidityDelta", "type": "int256" }], "name": "ModifyPosition", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "oldOwner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }], "name": "OwnerChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "protocolFeeController", "type": "address" }], "name": "ProtocolFeeControllerUpdated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "PoolId", "name": "id", "type": "bytes32" }, { "indexed": false, "internalType": "uint24", "name": "protocolFees", "type": "uint24" }], "name": "ProtocolFeeUpdated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "PoolId", "name": "id", "type": "bytes32" }, { "indexed": true, "internalType": "address", "name": "sender", "type": "address" }, { "indexed": false, "internalType": "int128", "name": "amount0", "type": "int128" }, { "indexed": false, "internalType": "int128", "name": "amount1", "type": "int128" }, { "indexed": false, "internalType": "uint160", "name": "sqrtPriceX96", "type": "uint160" }, { "indexed": false, "internalType": "uint128", "name": "liquidity", "type": "uint128" }, { "indexed": false, "internalType": "int24", "name": "tick", "type": "int24" }, { "indexed": false, "internalType": "uint24", "name": "fee", "type": "uint24" }], "name": "Swap", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "operator", "type": "address" }, { "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256[]", "name": "ids", "type": "uint256[]" }, { "indexed": false, "internalType": "uint256[]", "name": "values", "type": "uint256[]" }], "name": "TransferBatch", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "operator", "type": "address" }, { "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "id", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "TransferSingle", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "string", "name": "value", "type": "string" }, { "indexed": true, "internalType": "uint256", "name": "id", "type": "uint256" }], "name": "URI", "type": "event" }, { "inputs": [], "name": "MAX_TICK_SPACING", "outputs": [{ "internalType": "int24", "name": "", "type": "int24" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "MIN_PROTOCOL_FEE_DENOMINATOR", "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "MIN_TICK_SPACING", "outputs": [{ "internalType": "int24", "name": "", "type": "int24" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }, { "internalType": "uint256", "name": "id", "type": "uint256" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address[]", "name": "accounts", "type": "address[]" }, { "internalType": "uint256[]", "name": "ids", "type": "uint256[]" }], "name": "balanceOfBatch", "outputs": [{ "internalType": "uint256[]", "name": "", "type": "uint256[]" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "recipient", "type": "address" }, { "internalType": "Currency", "name": "currency", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "collectHookFees", "outputs": [{ "internalType": "uint256", "name": "amountCollected", "type": "uint256" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "recipient", "type": "address" }, { "internalType": "Currency", "name": "currency", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "collectProtocolFees", "outputs": [{ "internalType": "uint256", "name": "amountCollected", "type": "uint256" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "locker", "type": "address" }, { "internalType": "Currency", "name": "currency", "type": "address" }], "name": "currencyDelta", "outputs": [{ "internalType": "int256", "name": "currencyDelta", "type": "int256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "components": [{ "internalType": "Currency", "name": "currency0", "type": "address" }, { "internalType": "Currency", "name": "currency1", "type": "address" }, { "internalType": "uint24", "name": "fee", "type": "uint24" }, { "internalType": "int24", "name": "tickSpacing", "type": "int24" }, { "internalType": "contract IHooks", "name": "hooks", "type": "address" }], "internalType": "struct PoolKey", "name": "key", "type": "tuple" }, { "internalType": "uint256", "name": "amount0", "type": "uint256" }, { "internalType": "uint256", "name": "amount1", "type": "uint256" }, { "internalType": "bytes", "name": "hookData", "type": "bytes" }], "name": "donate", "outputs": [{ "internalType": "BalanceDelta", "name": "delta", "type": "int256" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "bytes32", "name": "slot", "type": "bytes32" }], "name": "extsload", "outputs": [{ "internalType": "bytes32", "name": "value", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "bytes32", "name": "startSlot", "type": "bytes32" }, { "internalType": "uint256", "name": "nSlots", "type": "uint256" }], "name": "extsload", "outputs": [{ "internalType": "bytes", "name": "", "type": "bytes" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "PoolId", "name": "id", "type": "bytes32" }, { "internalType": "address", "name": "_owner", "type": "address" }, { "internalType": "int24", "name": "tickLower", "type": "int24" }, { "internalType": "int24", "name": "tickUpper", "type": "int24" }], "name": "getLiquidity", "outputs": [{ "internalType": "uint128", "name": "liquidity", "type": "uint128" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "PoolId", "name": "id", "type": "bytes32" }], "name": "getLiquidity", "outputs": [{ "internalType": "uint128", "name": "liquidity", "type": "uint128" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "i", "type": "uint256" }], "name": "getLock", "outputs": [{ "internalType": "address", "name": "locker", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "PoolId", "name": "id", "type": "bytes32" }, { "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "int24", "name": "tickLower", "type": "int24" }, { "internalType": "int24", "name": "tickUpper", "type": "int24" }], "name": "getPosition", "outputs": [{ "components": [{ "internalType": "uint128", "name": "liquidity", "type": "uint128" }, { "internalType": "uint256", "name": "feeGrowthInside0LastX128", "type": "uint256" }, { "internalType": "uint256", "name": "feeGrowthInside1LastX128", "type": "uint256" }], "internalType": "struct Position.Info", "name": "position", "type": "tuple" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "PoolId", "name": "id", "type": "bytes32" }], "name": "getSlot0", "outputs": [{ "internalType": "uint160", "name": "sqrtPriceX96", "type": "uint160" }, { "internalType": "int24", "name": "tick", "type": "int24" }, { "internalType": "uint24", "name": "protocolFees", "type": "uint24" }, { "internalType": "uint24", "name": "hookFees", "type": "uint24" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "hookAddress", "type": "address" }, { "internalType": "Currency", "name": "currency", "type": "address" }], "name": "hookFeesAccrued", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "components": [{ "internalType": "Currency", "name": "currency0", "type": "address" }, { "internalType": "Currency", "name": "currency1", "type": "address" }, { "internalType": "uint24", "name": "fee", "type": "uint24" }, { "internalType": "int24", "name": "tickSpacing", "type": "int24" }, { "internalType": "contract IHooks", "name": "hooks", "type": "address" }], "internalType": "struct PoolKey", "name": "key", "type": "tuple" }, { "internalType": "uint160", "name": "sqrtPriceX96", "type": "uint160" }, { "internalType": "bytes", "name": "hookData", "type": "bytes" }], "name": "initialize", "outputs": [{ "internalType": "int24", "name": "tick", "type": "int24" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }, { "internalType": "address", "name": "operator", "type": "address" }], "name": "isApprovedForAll", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "bytes", "name": "data", "type": "bytes" }], "name": "lock", "outputs": [{ "internalType": "bytes", "name": "result", "type": "bytes" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "lockData", "outputs": [{ "internalType": "uint128", "name": "length", "type": "uint128" }, { "internalType": "uint128", "name": "nonzeroDeltaCount", "type": "uint128" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "Currency", "name": "currency", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "mint", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "components": [{ "internalType": "Currency", "name": "currency0", "type": "address" }, { "internalType": "Currency", "name": "currency1", "type": "address" }, { "internalType": "uint24", "name": "fee", "type": "uint24" }, { "internalType": "int24", "name": "tickSpacing", "type": "int24" }, { "internalType": "contract IHooks", "name": "hooks", "type": "address" }], "internalType": "struct PoolKey", "name": "key", "type": "tuple" }, { "components": [{ "internalType": "int24", "name": "tickLower", "type": "int24" }, { "internalType": "int24", "name": "tickUpper", "type": "int24" }, { "internalType": "int256", "name": "liquidityDelta", "type": "int256" }], "internalType": "struct IPoolManager.ModifyPositionParams", "name": "params", "type": "tuple" }, { "internalType": "bytes", "name": "hookData", "type": "bytes" }], "name": "modifyPosition", "outputs": [{ "internalType": "BalanceDelta", "name": "delta", "type": "int256" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "", "type": "address" }, { "internalType": "address", "name": "", "type": "address" }, { "internalType": "uint256[]", "name": "ids", "type": "uint256[]" }, { "internalType": "uint256[]", "name": "values", "type": "uint256[]" }, { "internalType": "bytes", "name": "", "type": "bytes" }], "name": "onERC1155BatchReceived", "outputs": [{ "internalType": "bytes4", "name": "", "type": "bytes4" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "", "type": "address" }, { "internalType": "address", "name": "", "type": "address" }, { "internalType": "uint256", "name": "id", "type": "uint256" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "bytes", "name": "", "type": "bytes" }], "name": "onERC1155Received", "outputs": [{ "internalType": "bytes4", "name": "", "type": "bytes4" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "PoolId", "name": "id", "type": "bytes32" }], "name": "pools", "outputs": [{ "components": [{ "internalType": "uint160", "name": "sqrtPriceX96", "type": "uint160" }, { "internalType": "int24", "name": "tick", "type": "int24" }, { "internalType": "uint24", "name": "protocolFees", "type": "uint24" }, { "internalType": "uint24", "name": "hookFees", "type": "uint24" }], "internalType": "struct Pool.Slot0", "name": "slot0", "type": "tuple" }, { "internalType": "uint256", "name": "feeGrowthGlobal0X128", "type": "uint256" }, { "internalType": "uint256", "name": "feeGrowthGlobal1X128", "type": "uint256" }, { "internalType": "uint128", "name": "liquidity", "type": "uint128" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "protocolFeeController", "outputs": [{ "internalType": "contract IProtocolFeeController", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "Currency", "name": "currency", "type": "address" }], "name": "protocolFeesAccrued", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "Currency", "name": "currency", "type": "address" }], "name": "reservesOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256[]", "name": "ids", "type": "uint256[]" }, { "internalType": "uint256[]", "name": "values", "type": "uint256[]" }, { "internalType": "bytes", "name": "data", "type": "bytes" }], "name": "safeBatchTransferFrom", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "id", "type": "uint256" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "bytes", "name": "data", "type": "bytes" }], "name": "safeTransferFrom", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "operator", "type": "address" }, { "internalType": "bool", "name": "approved", "type": "bool" }], "name": "setApprovalForAll", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "components": [{ "internalType": "Currency", "name": "currency0", "type": "address" }, { "internalType": "Currency", "name": "currency1", "type": "address" }, { "internalType": "uint24", "name": "fee", "type": "uint24" }, { "internalType": "int24", "name": "tickSpacing", "type": "int24" }, { "internalType": "contract IHooks", "name": "hooks", "type": "address" }], "internalType": "struct PoolKey", "name": "key", "type": "tuple" }], "name": "setHookFees", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_owner", "type": "address" }], "name": "setOwner", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "contract IProtocolFeeController", "name": "controller", "type": "address" }], "name": "setProtocolFeeController", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "components": [{ "internalType": "Currency", "name": "currency0", "type": "address" }, { "internalType": "Currency", "name": "currency1", "type": "address" }, { "internalType": "uint24", "name": "fee", "type": "uint24" }, { "internalType": "int24", "name": "tickSpacing", "type": "int24" }, { "internalType": "contract IHooks", "name": "hooks", "type": "address" }], "internalType": "struct PoolKey", "name": "key", "type": "tuple" }], "name": "setProtocolFees", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "Currency", "name": "currency", "type": "address" }], "name": "settle", "outputs": [{ "internalType": "uint256", "name": "paid", "type": "uint256" }], "stateMutability": "payable", "type": "function" }, { "inputs": [{ "internalType": "bytes4", "name": "interfaceId", "type": "bytes4" }], "name": "supportsInterface", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "components": [{ "internalType": "Currency", "name": "currency0", "type": "address" }, { "internalType": "Currency", "name": "currency1", "type": "address" }, { "internalType": "uint24", "name": "fee", "type": "uint24" }, { "internalType": "int24", "name": "tickSpacing", "type": "int24" }, { "internalType": "contract IHooks", "name": "hooks", "type": "address" }], "internalType": "struct PoolKey", "name": "key", "type": "tuple" }, { "components": [{ "internalType": "bool", "name": "zeroForOne", "type": "bool" }, { "internalType": "int256", "name": "amountSpecified", "type": "int256" }, { "internalType": "uint160", "name": "sqrtPriceLimitX96", "type": "uint160" }], "internalType": "struct IPoolManager.SwapParams", "name": "params", "type": "tuple" }, { "internalType": "bytes", "name": "hookData", "type": "bytes" }], "name": "swap", "outputs": [{ "internalType": "BalanceDelta", "name": "delta", "type": "int256" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "Currency", "name": "currency", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "take", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "uri", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "stateMutability": "payable", "type": "receive" }]

const MIN_TICK = -887220;
const MAX_TICK = -(MIN_TICK);

async function main() {
    const [admin, nftOwner1] = await ethers.getSigners()
    // const perksVaultContract = await ethers.getContractFactory("PerksVault")
    // const perksVault = await perksVaultContract.deploy(
    //     "0x5FF8780e4D20e75B8599A9C4528D8ac9682e5c89", // pool manager
    //     "0xEc0941828C0C8af69525F797efe9512de0b4A51a", // perks token
    //     )

    // console.log(perksVault.address)

    const provider = new ethers.providers.JsonRpcProvider("https://polygon-mumbai.infura.io/v3/06800f8293644a29b29acbc1148042f1")
    const perksVault = await ethers.getContractAt("PerksVault", "0x8078cB27dD51266950FE0317CB314F16f11Fac8b")
    const poolManager = await ethers.getContractAt("IPoolManager", "0x5FF8780e4D20e75B8599A9C4528D8ac9682e5c89")
    // const poolManager2 = new ethers.Contract(
    //     "0x5FF8780e4D20e75B8599A9C4528D8ac9682e5c89",
    //     poolManagerABI,
    //     ethers.getDefaultProvider()
    // )
    // console.log({ poolManager2 })

    const poolKey = await perksVault.uniswapPoolKey()
    console.log({ poolKey })

    const poolKeyString = JSON.stringify(poolKey);

    // Converting string to bytes
    const poolKeyBytes = Buffer.from(poolKeyString);

    // Hashing the bytes using keccak256
    const hash = ethers.utils.keccak256(poolKeyBytes);

    console.log({ hash })

    const hashBytes = ethers.utils.arrayify(hash)
    console.log({ hashBytes })

    const hashBytes32 = ethers.utils.hexZeroPad(hash, 32);
    console.log({ hashBytes32 })

    const poolId = getPoolId({
        currency0: poolKey.currency0,
        currency1: poolKey.currency1,
        fee: Number(poolKey.fee),
        tickSpacing: Number(poolKey.tickSpacing),
        hooks: poolKey.hooks,
    })
    console.log({ poolId })

    // console.log({fn: poolManager2.swap})
    // const liquidity = await poolManager.getLiquidity(hashBytes32)
    // console.log({ liquidity })
    // const poolStatus = await poolManager2.pools(hashBytes32)
    // console.log({ poolStatus })
    // const slot0 = await poolManager2.getSlot0(hashBytes32)
    // console.log({ slot0 })


    const modifyPositionParams = {
        // the lower and upper tick of the position
        tickLower: MIN_TICK,
        tickUpper: MAX_TICK,
        // how to modify the liquidity
        liquidityDelta: expandTo18Decimals(100),
    }

    const tx = await poolManager.connect(admin).modifyPosition(poolKey, modifyPositionParams, '0x00', { gasLimit: 1000000 })
    console.log(tx)
    await tx.wait()


}

function expandTo18Decimals(n: number): BigNumber {
    return BigNumber.from(n).mul(BigNumber.from(10).pow(18))
  }
  

function getPoolId({
    currency0,
    currency1,
    fee,
    tickSpacing,
    hooks,
  }: {
    currency0: string | Contract
    currency1: string | Contract
    fee: number
    tickSpacing: number
    hooks: string | Contract
  }): string {
    return ethers.utils.keccak256(
      ethers.utils.defaultAbiCoder.encode(
        ['address', 'address', 'uint24', 'int24', 'address'],
        [
          typeof currency0 === 'string' ? currency0 : currency0.address,
          typeof currency1 === 'string' ? currency1 : currency1.address,
          fee,
          tickSpacing,
          typeof hooks === 'string' ? hooks : hooks.address,
        ]
      )
    )
  }
  
  
main().catch((error) => {
    console.error(error);
    process.exitCode = 1;
});


// sepolia 0x4a4e97E89e63438811f7646E7802300d5Fd4Bb3F

// mumbai 0x8078cB27dD51266950FE0317CB314F16f11Fac8b